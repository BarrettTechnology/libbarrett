<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Xenomai API: cross-link.c</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li><a href="examples.html"><span>Examples</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<h1>cross-link.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * cross-link.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Userspace test program (Xenomai native skin) for RTDM-based UART drivers</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright 2005 by Joerg Langenberg &lt;joergel75@gmx.net&gt;</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Updates by Jan Kiszka &lt;jan.kiszka@web.de&gt;</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00012"></a>00012 <span class="comment"> * (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="task_8h.html" title="This file is part of the Xenomai project.">native/task.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="include_2native_2timer_8h.html" title="This file is part of the Xenomai project.">native/timer.h</a>&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="rtserial_8h.html" title="Real-Time Driver Model for Xenomai, serial device profile header.">rtdm/rtserial.h</a>&gt;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#define MAIN_PREFIX   "main : "</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#define WTASK_PREFIX  "write_task: "</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#define RTASK_PREFIX  "read_task: "</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#define WRITE_FILE    "rtser0"</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define READ_FILE     "rtser1"</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="keywordtype">int</span> read_fd  = -1;
<a name="l00041"></a>00041 <span class="keywordtype">int</span> write_fd = -1;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#define STATE_FILE_OPENED         1</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#define STATE_TASK_CREATED        2</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> read_state = 0;
<a name="l00047"></a>00047 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> write_state = 0;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment">/*                           --s-ms-us-ns */</span>
<a name="l00050"></a>00050 RTIME write_task_period_ns =    100000000llu;
<a name="l00051"></a>00051 RT_TASK write_task;
<a name="l00052"></a>00052 RT_TASK read_task;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>rtser_config read_config = {
<a name="l00055"></a>00055         .config_mask       = 0xFFFF,
<a name="l00056"></a>00056         .baud_rate         = 115200,
<a name="l00057"></a>00057         .parity            = RTSER_DEF_PARITY,
<a name="l00058"></a>00058         .data_bits         = RTSER_DEF_BITS,
<a name="l00059"></a>00059         .stop_bits         = RTSER_DEF_STOPB,
<a name="l00060"></a>00060         .handshake         = RTSER_DEF_HAND,
<a name="l00061"></a>00061         .fifo_depth        = RTSER_DEF_FIFO_DEPTH,
<a name="l00062"></a>00062         .rx_timeout        = RTSER_DEF_TIMEOUT,
<a name="l00063"></a>00063         .tx_timeout        = RTSER_DEF_TIMEOUT,
<a name="l00064"></a>00064         .event_timeout     = 1000000000, <span class="comment">/* 1 s */</span>
<a name="l00065"></a>00065         .timestamp_history = RTSER_RX_TIMESTAMP_HISTORY,
<a name="l00066"></a>00066         .event_mask        = RTSER_EVENT_RXPEND,
<a name="l00067"></a>00067 };
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>rtser_config write_config = {
<a name="l00070"></a>00070         .config_mask       = RTSER_SET_BAUD | RTSER_SET_TIMESTAMP_HISTORY,
<a name="l00071"></a>00071         .baud_rate         = 115200,
<a name="l00072"></a>00072         .timestamp_history = RTSER_DEF_TIMESTAMP_HISTORY,
<a name="l00073"></a>00073         <span class="comment">/* the rest implicitely remains default */</span>
<a name="l00074"></a>00074 };
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">static</span> <span class="keywordtype">int</span> close_file( <span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *name)
<a name="l00077"></a>00077 {
<a name="l00078"></a>00078         <span class="keywordtype">int</span> err, i=0;
<a name="l00079"></a>00079         
<a name="l00080"></a>00080         <span class="keywordflow">do</span> {
<a name="l00081"></a>00081                 i++;
<a name="l00082"></a>00082                 err = rt_dev_close(fd);
<a name="l00083"></a>00083                 <span class="keywordflow">switch</span> (err) {
<a name="l00084"></a>00084                 <span class="keywordflow">case</span> -EAGAIN:
<a name="l00085"></a>00085                         printf(MAIN_PREFIX <span class="stringliteral">"%s -&gt; EAGAIN (%d times)\n"</span>,
<a name="l00086"></a>00086                                name, i);
<a name="l00087"></a>00087                         <a name="a0"></a><a class="code" href="group__task.html#gd5225e5fb8d583fbdfa5299f322b8366">rt_task_sleep</a>(50000); <span class="comment">/* wait 50us */</span>
<a name="l00088"></a>00088                         <span class="keywordflow">break</span>;
<a name="l00089"></a>00089                 <span class="keywordflow">case</span> 0:
<a name="l00090"></a>00090                         printf(MAIN_PREFIX <span class="stringliteral">"%s -&gt; closed\n"</span>, name);
<a name="l00091"></a>00091                         <span class="keywordflow">break</span>;
<a name="l00092"></a>00092                 <span class="keywordflow">default</span>:
<a name="l00093"></a>00093                         printf(MAIN_PREFIX <span class="stringliteral">"%s -&gt; %s\n"</span>, name,
<a name="l00094"></a>00094                                strerror(-err));
<a name="l00095"></a>00095                         <span class="keywordflow">break</span>;
<a name="l00096"></a>00096                 }
<a name="l00097"></a>00097         } <span class="keywordflow">while</span> (err == -EAGAIN &amp;&amp; i &lt; 10);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         <span class="keywordflow">return</span> err;
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="keywordtype">void</span> cleanup_all(<span class="keywordtype">void</span>)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104         <span class="keywordflow">if</span> (read_state &amp; STATE_FILE_OPENED) {
<a name="l00105"></a>00105                 close_file(read_fd, READ_FILE<span class="stringliteral">" (read)"</span>);
<a name="l00106"></a>00106                 read_state &amp;= ~STATE_FILE_OPENED;
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108         
<a name="l00109"></a>00109         <span class="keywordflow">if</span> (write_state &amp; STATE_FILE_OPENED) {
<a name="l00110"></a>00110                 close_file(write_fd, WRITE_FILE <span class="stringliteral">" (write)"</span>);
<a name="l00111"></a>00111                 write_state &amp;= ~STATE_FILE_OPENED;
<a name="l00112"></a>00112         }
<a name="l00113"></a>00113         
<a name="l00114"></a>00114         <span class="keywordflow">if</span> (write_state &amp; STATE_TASK_CREATED) {
<a name="l00115"></a>00115                 printf(MAIN_PREFIX <span class="stringliteral">"delete write_task\n"</span>);
<a name="l00116"></a>00116                 <a name="a1"></a><a class="code" href="group__task.html#gb6e0d411830710e8cc82d77b9df19510">rt_task_delete</a>(&amp;write_task);
<a name="l00117"></a>00117                 write_state &amp;= ~STATE_TASK_CREATED;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         
<a name="l00120"></a>00120         <span class="keywordflow">if</span> (read_state &amp; STATE_TASK_CREATED) {
<a name="l00121"></a>00121                 printf(MAIN_PREFIX <span class="stringliteral">"delete read_task\n"</span>);
<a name="l00122"></a>00122                 <a class="code" href="group__task.html#gb6e0d411830710e8cc82d77b9df19510">rt_task_delete</a>(&amp;read_task);
<a name="l00123"></a>00123                 read_state &amp;= ~STATE_TASK_CREATED;
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="keywordtype">void</span> catch_signal(<span class="keywordtype">int</span> sig)
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129         cleanup_all();
<a name="l00130"></a>00130         printf(MAIN_PREFIX <span class="stringliteral">"exit\n"</span>);
<a name="l00131"></a>00131         <span class="keywordflow">return</span>;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keywordtype">void</span> write_task_proc(<span class="keywordtype">void</span> *arg)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136         <span class="keywordtype">int</span> err;
<a name="l00137"></a>00137         RTIME write_time;
<a name="l00138"></a>00138         ssize_t sz = <span class="keyword">sizeof</span>(RTIME);
<a name="l00139"></a>00139         ssize_t written = 0;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         err = <a name="a2"></a><a class="code" href="group__task.html#gbabee94264156693cd4f5b9b70d3c5a1">rt_task_set_periodic</a>(NULL, TM_NOW,
<a name="l00142"></a>00142                                    rt_timer_ns2ticks(write_task_period_ns));
<a name="l00143"></a>00143         <span class="keywordflow">if</span> (err) {
<a name="l00144"></a>00144                 printf(WTASK_PREFIX <span class="stringliteral">"error on set periodic, %s\n"</span>,
<a name="l00145"></a>00145                        strerror(-err));
<a name="l00146"></a>00146                 <span class="keywordflow">goto</span> exit_write_task;
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="keywordflow">while</span> (1) {
<a name="l00150"></a>00150                 err = <a name="a3"></a><a class="code" href="group__task.html#g1645d3a072ef3cefeed3bcbb27dcf108">rt_task_wait_period</a>(NULL);
<a name="l00151"></a>00151                 <span class="keywordflow">if</span> (err) {
<a name="l00152"></a>00152                         printf(WTASK_PREFIX
<a name="l00153"></a>00153                                <span class="stringliteral">"error on rt_task_wait_period, %s\n"</span>,
<a name="l00154"></a>00154                                strerror(-err));
<a name="l00155"></a>00155                         <span class="keywordflow">break</span>;
<a name="l00156"></a>00156                 }
<a name="l00157"></a>00157         
<a name="l00158"></a>00158                 write_time = rt_timer_read();
<a name="l00159"></a>00159 
<a name="l00160"></a>00160                 written = rt_dev_write(write_fd, &amp;write_time, sz);
<a name="l00161"></a>00161                 <span class="keywordflow">if</span> (written &lt; 0 ) {
<a name="l00162"></a>00162                         printf(WTASK_PREFIX <span class="stringliteral">"error on rt_dev_write, %s\n"</span>,
<a name="l00163"></a>00163                                strerror(-err));
<a name="l00164"></a>00164                         <span class="keywordflow">break</span>;
<a name="l00165"></a>00165                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (written != sz) {
<a name="l00166"></a>00166                         printf(WTASK_PREFIX <span class="stringliteral">"only %d / %d byte transmitted\n"</span>,
<a name="l00167"></a>00167                                written, sz);
<a name="l00168"></a>00168                         <span class="keywordflow">break</span>;
<a name="l00169"></a>00169                 }
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172  exit_write_task:
<a name="l00173"></a>00173         <span class="keywordflow">if</span> ((write_state &amp; STATE_FILE_OPENED) &amp;&amp;
<a name="l00174"></a>00174             close_file(write_fd, WRITE_FILE <span class="stringliteral">" (write)"</span>) == 0)
<a name="l00175"></a>00175                 write_state &amp;= ~STATE_FILE_OPENED;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         printf(WTASK_PREFIX <span class="stringliteral">"exit\n"</span>);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keywordtype">void</span> read_task_proc(<span class="keywordtype">void</span> *arg)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182         <span class="keywordtype">int</span> err;
<a name="l00183"></a>00183         <span class="keywordtype">int</span> nr = 0;
<a name="l00184"></a>00184         RTIME read_time  = 0;
<a name="l00185"></a>00185         RTIME write_time = 0;
<a name="l00186"></a>00186         RTIME irq_time   = 0;
<a name="l00187"></a>00187         ssize_t sz = <span class="keyword">sizeof</span>(RTIME);
<a name="l00188"></a>00188         ssize_t read = 0;
<a name="l00189"></a>00189         <span class="keyword">struct </span>rtser_event rx_event;
<a name="l00190"></a>00190         
<a name="l00191"></a>00191         printf(<span class="stringliteral">" Nr |   write-&gt;irq    |    irq-&gt;read    |   write-&gt;read   |\n"</span>);
<a name="l00192"></a>00192         printf(<span class="stringliteral">"-----------------------------------------------------------\n"</span>);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         <span class="comment">/*</span>
<a name="l00195"></a>00195 <span class="comment">         * We are in secondary mode now due to printf, the next</span>
<a name="l00196"></a>00196 <span class="comment">         * blocking Xenomai or driver call will switch us back</span>
<a name="l00197"></a>00197 <span class="comment">         * (here: RTSER_RTIOC_WAIT_EVENT).</span>
<a name="l00198"></a>00198 <span class="comment">         */</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="keywordflow">while</span> (1) {
<a name="l00201"></a>00201                 <span class="comment">/* waiting for event */</span>
<a name="l00202"></a>00202                 err = rt_dev_ioctl(read_fd, <a name="a4"></a><a class="code" href="group__rtserial.html#g3e3c22ccee4a2f49481e7084246c06ff" title="Wait on serial device events according to previously set mask.">RTSER_RTIOC_WAIT_EVENT</a>, &amp;rx_event);
<a name="l00203"></a>00203                 <span class="keywordflow">if</span> (err) {
<a name="l00204"></a>00204                         printf(RTASK_PREFIX
<a name="l00205"></a>00205                                <span class="stringliteral">"error on RTSER_RTIOC_WAIT_EVENT, %s\n"</span>,
<a name="l00206"></a>00206                                strerror(-err));
<a name="l00207"></a>00207                         <span class="keywordflow">if</span> (err == -ETIMEDOUT)
<a name="l00208"></a>00208                                 <span class="keywordflow">continue</span>;
<a name="l00209"></a>00209                         <span class="keywordflow">break</span>;
<a name="l00210"></a>00210                 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212                 irq_time = rx_event.rxpend_timestamp;
<a name="l00213"></a>00213                 read = rt_dev_read(read_fd, &amp;write_time, sz);
<a name="l00214"></a>00214                 <span class="keywordflow">if</span> (read == sz) {
<a name="l00215"></a>00215                         read_time = rt_timer_read();
<a name="l00216"></a>00216                         printf(<span class="stringliteral">"%3d |%16llu |%16llu |%16llu\n"</span>, nr,
<a name="l00217"></a>00217                                irq_time  - write_time,
<a name="l00218"></a>00218                                read_time - irq_time,
<a name="l00219"></a>00219                                read_time - write_time);
<a name="l00220"></a>00220                         nr++;
<a name="l00221"></a>00221                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (read &lt; 0 ) {
<a name="l00222"></a>00222                         printf(RTASK_PREFIX <span class="stringliteral">"error on rt_dev_read, code %s\n"</span>,
<a name="l00223"></a>00223                                strerror(-err));
<a name="l00224"></a>00224                         <span class="keywordflow">break</span>;
<a name="l00225"></a>00225                 } <span class="keywordflow">else</span> {
<a name="l00226"></a>00226                         printf(RTASK_PREFIX <span class="stringliteral">"only %d / %d byte received \n"</span>,
<a name="l00227"></a>00227                                read, sz);
<a name="l00228"></a>00228                         <span class="keywordflow">break</span>;
<a name="l00229"></a>00229                 }
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="keywordflow">if</span> ((read_state &amp; STATE_FILE_OPENED) &amp;&amp;
<a name="l00233"></a>00233             close_file(read_fd, READ_FILE <span class="stringliteral">" (read)"</span>) == 0)
<a name="l00234"></a>00234                 read_state &amp;= ~STATE_FILE_OPENED;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         printf(RTASK_PREFIX <span class="stringliteral">"exit\n"</span>);
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241         <span class="keywordtype">int</span> err = 0;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         signal(SIGTERM, catch_signal);
<a name="l00244"></a>00244         signal(SIGINT, catch_signal);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment">/* no memory-swapping for this programm */</span>
<a name="l00247"></a>00247         mlockall(MCL_CURRENT | MCL_FUTURE);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         <span class="comment">/* open rtser0 */</span>
<a name="l00250"></a>00250         write_fd = rt_dev_open( WRITE_FILE, 0);
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (write_fd &lt; 0) {
<a name="l00252"></a>00252                 printf(MAIN_PREFIX <span class="stringliteral">"can't open %s (write), %s\n"</span>, WRITE_FILE,
<a name="l00253"></a>00253                        strerror(-write_fd));
<a name="l00254"></a>00254                 <span class="keywordflow">goto</span> error;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256         write_state |= STATE_FILE_OPENED;
<a name="l00257"></a>00257         printf(MAIN_PREFIX <span class="stringliteral">"write-file opened\n"</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="comment">/* writing write-config */</span>
<a name="l00260"></a>00260         err = rt_dev_ioctl(write_fd, <a name="a5"></a><a class="code" href="group__rtserial.html#g138321c1f5bba234c8a7d7fc912aaaf8" title="Set serial device configuration.">RTSER_RTIOC_SET_CONFIG</a>, &amp;write_config);
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (err) {
<a name="l00262"></a>00262                 printf(MAIN_PREFIX <span class="stringliteral">"error while RTSER_RTIOC_SET_CONFIG, %s\n"</span>,
<a name="l00263"></a>00263                        strerror(-err));
<a name="l00264"></a>00264                 <span class="keywordflow">goto</span> error;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266         printf(MAIN_PREFIX <span class="stringliteral">"write-config written\n"</span>);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="comment">/* open rtser1 */</span>
<a name="l00269"></a>00269         read_fd = rt_dev_open( READ_FILE, 0 );
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (read_fd &lt; 0) {
<a name="l00271"></a>00271                 printf(MAIN_PREFIX <span class="stringliteral">"can't open %s (read), %s\n"</span>, READ_FILE,
<a name="l00272"></a>00272                        strerror(-read_fd));
<a name="l00273"></a>00273                 <span class="keywordflow">goto</span> error;
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         read_state |= STATE_FILE_OPENED;
<a name="l00276"></a>00276         printf(MAIN_PREFIX <span class="stringliteral">"read-file opened\n"</span>);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">/* writing read-config */</span>
<a name="l00279"></a>00279         err = rt_dev_ioctl(read_fd, <a class="code" href="group__rtserial.html#g138321c1f5bba234c8a7d7fc912aaaf8" title="Set serial device configuration.">RTSER_RTIOC_SET_CONFIG</a>, &amp;read_config);
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (err) {
<a name="l00281"></a>00281                 printf(MAIN_PREFIX <span class="stringliteral">"error while rt_dev_ioctl, %s\n"</span>,
<a name="l00282"></a>00282                        strerror(-err));
<a name="l00283"></a>00283                 <span class="keywordflow">goto</span> error;
<a name="l00284"></a>00284         }
<a name="l00285"></a>00285         printf(MAIN_PREFIX <span class="stringliteral">"read-config written\n"</span>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">/* create write_task */</span>
<a name="l00288"></a>00288         err = <a name="a6"></a><a class="code" href="group__task.html#g03387550693c21d0223f739570ccd992">rt_task_create</a>(&amp;write_task, <span class="stringliteral">"write_task"</span>, 0, 50, 0);
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (err) {
<a name="l00290"></a>00290                 printf(MAIN_PREFIX <span class="stringliteral">"failed to create write_task, %s\n"</span>,
<a name="l00291"></a>00291                        strerror(-err));
<a name="l00292"></a>00292                 <span class="keywordflow">goto</span> error;
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         write_state |= STATE_TASK_CREATED;
<a name="l00295"></a>00295         printf(MAIN_PREFIX <span class="stringliteral">"write-task created\n"</span>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="comment">/* create read_task */</span>
<a name="l00298"></a>00298         err = <a class="code" href="group__task.html#g03387550693c21d0223f739570ccd992">rt_task_create</a>(&amp;read_task, <span class="stringliteral">"read_task"</span>, 0, 51, 0);
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (err) {
<a name="l00300"></a>00300                 printf(MAIN_PREFIX <span class="stringliteral">"failed to create read_task, %s\n"</span>,
<a name="l00301"></a>00301                        strerror(-err));
<a name="l00302"></a>00302                 <span class="keywordflow">goto</span> error;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304         read_state |= STATE_TASK_CREATED;
<a name="l00305"></a>00305         printf(MAIN_PREFIX <span class="stringliteral">"read-task created\n"</span>);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <span class="comment">/* start write_task */</span>
<a name="l00308"></a>00308         printf(MAIN_PREFIX <span class="stringliteral">"starting write-task\n"</span>);
<a name="l00309"></a>00309         err = <a name="a7"></a><a class="code" href="group__task.html#gc9638918b8310a430088f5c9a04d2bb7">rt_task_start</a>(&amp;write_task, &amp;write_task_proc, NULL);
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (err) {
<a name="l00311"></a>00311                 printf(MAIN_PREFIX <span class="stringliteral">"failed to start write_task, %s\n"</span>,
<a name="l00312"></a>00312                        strerror(-err));
<a name="l00313"></a>00313                 <span class="keywordflow">goto</span> error;
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="comment">/* start read_task */</span>
<a name="l00317"></a>00317         printf(MAIN_PREFIX <span class="stringliteral">"starting read-task\n"</span>);
<a name="l00318"></a>00318         err = <a class="code" href="group__task.html#gc9638918b8310a430088f5c9a04d2bb7">rt_task_start</a>(&amp;read_task,&amp;read_task_proc,NULL);
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (err) {
<a name="l00320"></a>00320                 printf(MAIN_PREFIX <span class="stringliteral">"failed to start read_task, %s\n"</span>,
<a name="l00321"></a>00321                        strerror(-err));
<a name="l00322"></a>00322                 <span class="keywordflow">goto</span> error;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         pause();
<a name="l00326"></a>00326         <span class="keywordflow">return</span> 0;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328  error:
<a name="l00329"></a>00329         cleanup_all();
<a name="l00330"></a>00330         <span class="keywordflow">return</span> err;
<a name="l00331"></a>00331 }
</pre></div> <hr size="1"><address style="text-align: right;"><small>Generated on Mon Feb 11 12:33:52 2008 for Xenomai API by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
